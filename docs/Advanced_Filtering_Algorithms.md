# 高级触控与热力图滤波算法指南 (Advanced Touch Filtering Algorithms)

本文档整理了适用于触控热力图 (Heatmap) 处理以及前端坐标平滑的几种业界主流高级算法。由于我们的目标是将 **40x60** 的低分辨率矩阵高精度地映射到 **2560x1600** 的物理屏幕上，并且要达到**次像素（Sub-pixel）级别**的精度，因此我们**绝不能使用二值化和形态学操作**（因为那样会丢失极其珍贵的边缘信号强度信息）。

以下算法着重于：在保留完整 16-bit 信号深度（Intensity）的前提下，如何计算出最稳定、最高精度的触控点坐标流。

---

## 1. 1欧元滤波器 (1€ Filter / One Euro Filter) 💶
**（您专门提到的“欧元算法”，这是人机交互领域极具盛名的坐标/轨迹滤波器）**

* **应用阶段**：作用于最终计算出的坐标点 `(X, Y)`，而非原始的 40x60 热力图矩阵。
* **核心痛点**：传统的低通滤波器 (Low-pass Filter) 面临一个无解的矛盾——如果过滤强度高（平滑），就会产生严重的“拖影/延迟(Lag)”；如果过滤强度低，在手指慢速移动或悬停时，光标就会“疯狂抖动(Jitter)”。
* **算法原理**：1€滤波器创造性地引入了**自适应截止频率 (Adaptive Cutoff Frequency)**。
  它会实时计算手指移动的**速度**：
  * **当速度极慢或静止时**：它认为此时的波动全是噪声（手抖或电容底噪），于是大幅压低截止频率（强力平滑），使点如磐石般稳定。
  * **当速度极快（快速划动）时**：它认为此时位置的变化主要是用户意图，应当尽可能保留最新位置。于是大幅调高截止频率（降低平滑），让光标紧紧跟手，做到**零延迟**。
* **为什么叫 1€？**：作者发现只需要在公式里调两个简单的参数（`f_min` 和 `beta`），就能实现极低成本、极高收益的效果，因为它的计算开销仅仅是“1欧元”级别的（非常廉价，不到卡尔曼滤波器的十分之一）。

---

## 2. 3x3 中值滤波器 (Median Filter)
* **应用阶段**：空域处理（作用于 40x60 矩阵）。
* **核心痛点**：硬件 ADC 偶尔会采样到孤立的极大值或极小值噪点（椒盐噪声），如果直接进行重心计算，会将坐标大幅拉偏。
* **算法原理**：取每个像素周围 3x3（共9个）的像素，将数值排序，取中位数覆盖原值。
* **独特优势**：能够毫无保留地**消除孤立噪点**，同时**绝对不会模糊真实触控信号的边缘**！这是它秒杀高斯滤波的地方，能够完美保护波峰的陡峭程度，对连通域（Blob）提取极为有利。

---

## 3. 自适应基线追踪 (Adaptive Baseline Tracking)
* **应用阶段**：时域处理（作用于原始 ADC 矩阵）。
* **核心痛点**：电容屏受温度、湿度、形变、老化等影响，原本没有触摸时的 `0x7FFE` 基准线会随着时间发生漂移。如果一直减去固定的基线，会导致“死区”失效，造成满屏幽灵触控。
* **算法原理**：在没有检测到强触摸信号的区域，使用极慢的低通滤波去不断更新底部的 `Baseline Matrix (40x60)`。如果有强信号（手指按下），则冻结该区域的基线更新。
* **独特优势**：它能完全取代一刀切的硬死区（Hard Deadzone），让系统对极其微弱的悬浮或细笔尖信号依然保持灵敏，同时不受环境温漂影响。

---

## 4. 空间高斯滤波 / 均值平滑 (Gaussian Smoothing)
* **应用阶段**：空域处理（在寻找连通域之前）。
* **核心痛点**：手指如果是干的，或者环境噪声大，触控区域的热力分布可能是坑洼不平的（多个小山头），这会让重心算法算出的中心点不断跳跃。
* **算法原理**：使用一个 2D 的高斯卷积核（如 3x3）扫遍矩阵，模拟扩散效应。
* **独特优势**：把坑洼的信号“揉”成一个完美的 2D 钟形面 (Gaussian Bell 面)。这样计算出的加权质心 (Centroid) 坐标会极其圆滑且稳定。通常与中值滤波结合使用（先中值去极值，再高斯平滑）。

---

## 5. 高精度次像素质心算法 (Sub-pixel Centroid Calculation) 🎯
**（这是将 40x60 矩阵跨越到 2560x1600 物理像素甚至更高精度的绝对核心！）**

* **应用阶段**：坐标提取阶段（连通域提取时）。
* **核心痛点**：普通算法如果强行把 40 放大到 2560（放大 64 倍），坐标就会像是在走“阶梯”，线条全是锯齿状的。强行二值化会彻底丢失山峰的走势信息。
* **算法原理**：
  在划分出一个手指所在的 3x3 或更大的一滩非零信号区域后，**绝不二值化**，而是直接利用每一个格子的信号强度（Intensity，如 `int16_t` 数值）来算质心：
  1. **加权质心法 (Intensity-Weighted Centroid / Center of Mass)**:
     这是最经典的做法。把格子的坐标 `(x, y)` 乘上它的信号强度 `w(x, y)`，然后求均值。
     公式：`X = Σ(x * w(x,y)) / Σw(x,y)` 。
     这意味着如果右边的格子比左边亮一点点，坐标就会非常细腻地向右偏移 0.01 个格子，从而计算出 `X = 23.45` 这样的小数坐标。
  2. **二维高斯抛物面拟合 (2D Gaussian/Parabolic Fitting)**:
     更高级的做法。因为真实的手指压在电容屏上的物理形态绝对是一个完美的“倒钟形”。找出最亮的极值像素 `(x, y)`，然后取其上、下、左、右四个相邻像素的强度值，利用二阶泰勒展开或抛物线顶点公式，直接计算出这个“钟”真正的物理极高点在哪里。
* **独特优势**：能够在一块仅有 40x60 物理网线的极低分辨率传感器上，算出 `(23.4552, 11.8901)` 这种包含无穷精度的小数点坐标！结合最终的 `x * (2560/60)` 映射，能让光标在 12.35 寸屏幕上实现像素级顺滑的移动。

---

## 6. 卡尔曼滤波器 (Kalman Filter)
* **应用阶段**：端点轨迹处理流 `(X, Y)`，或结合速度预测。
* **核心痛点**：普通的移动平均滤波会导致落后（Lag）。
* **算法原理**：卡尔曼不仅相信当前的测量坐标，还通过建立物理状态方程（位置、速度、加速度），“**预测**”下一帧在哪。然后将“预测值”与“充满噪声的测量值”通过卡尔曼增益（Kalman Gain）进行最优融合。
* **独特优势**：在极端环境（比如扫描率断崖式掉帧、信号极差）下，它甚至能强行“推算”并脑补出一段丝滑的曲线，特别适合高阶书写和绘图场景，但算力开销较高。

---

### 总结与推荐方案
若要在当前的 `EGoTouchRev` 架构下实现 40x60 到 12.35寸 2560x1600 屏幕的次像素极致映射：
1. **矩阵层面**：使用 **3x3 中值滤波** 去除会导致质心偏移的极值噪点，然后使用紧邻的 **3x3 高斯平滑** 将波峰揉圆。
2. **提取层面**：使用 **加权质心法 / 二维高斯拟合法** 直接利用 `int16_t` 计算出带小数点的精确坐标 `(X_sub, Y_sub)`。
3. **坐标映射**：将计算出的连续坐标乘以物理映射比例（X_sub * (60 -> 2560), Y_sub * (40 -> 1600)）。
4. **末端滤波**：在最终的 2560x1600 坐标流上挂载 **1€ (One Euro) 滤波器**进行动态平滑与去抖，彻底消除剩余抖动并保证极致跟手。
