# 技术细节报告 (Technical Details)

本文档记录了 `EGoTouch-Rev` 项目开发过程中的逆向工程发现、数据结构分析及未来开发方向。

## 1. 逆向工程发现

### 启动逻辑
*   **启动函数**: `thp_afe_start`
*   **发现**: 目前发现华为官方驱动中的 `thp_afe_start` 与 `himax_debug` / `himax_inspection` 工具中的启动逻辑非常相近。这表明我们可以参考这些调试工具的流程来完善我们的初始化逻辑。

### 数据帧结构分析

#### Master Frame
Master 设备返回的数据帧包含触摸屏的核心热力图数据。
*   **结构**:
    *   **0-6 字节**: 校验位 (Header/Checksum)。
    *   **中间 4800 字节**: 原始热力图数据 (Raw Heatmap)。数据以小端序 (Little-Endian) 两两组合。
    *   **后 256 字节**: 状态表 (Status Table)。
        *   包含是否收到有效信号的标志。
        *   包含单只手指的整数坐标。
        *   包含手写笔的压力 (Pressure) 和倾斜角 (Tilt) 信息。
*   **结论**: 由于主要数据是热力图而非处理后的坐标，且状态表虽有坐标但不完整，因此该 Frame **无法直接用于** 向操作系统回报 HID 坐标。

#### Slave Frame
Slave 设备的数据帧目前推测与手写笔增强功能有关。
*   **推测**: 该 Frame 大概对应 Linux 驱动方案中的 `neg_noise` (Negative Noise?) 相关处理。
*   **关联**: 似乎与手写笔功能的实现紧密相关。

### 手写笔与 240Hz 模式
*   **状态**: 未启动。
*   **机制**: 240Hz 高刷新率模式（通常用于降低手写笔延迟）似乎需要向一个特定的寄存器表发送命令才能激活。目前尚未定位到确切的寄存器序列。

## 2. 技术路线与未来方向

针对目前获取到的数据特性，主要存在两个后续开发方向：

### 方向一：热力图解算 (Heatmap Solving)
*   **思路**: 维持目前的 RAW DATA 模式，在 User Mode 驱动中自行实现算法。
*   **工作**: 解析 Master Frame 中的 4800 字节热力图数据，通过聚类、质心计算等算法得出触摸点坐标，并处理多点触控和手写笔轨迹。
*   **优点**: 拥有最大的灵活性，可以自定义滤波算法优化“鬼影”问题。
*   **缺点**: 算法复杂度高，开发难度大，性能开销相对较高。

### 方向二：切换 Normal 模式 (Switch to Normal Mode)
*   **思路**: 修改芯片的启动配置，使其工作在 "Normal" 模式。
*   **工作**: 逆向寻找将 IC 从 RAW DATA 模式切换到 Normal 处理模式的指令。在 Normal 模式下，IC 内部 DSP 会完成坐标计算，直接输出包含坐标点的结构体数据包。
*   **优点**: 极大简化驱动开发逻辑，直接读取坐标即可上报；降低 CPU 占用。
*   **缺点**: 需要精准的寄存器配置逆向，如果官方驱动完全依赖软件解算，硬件可能不支持或配置极难寻找。

## 3. 项目当前进度 (Status)

*   **[已实现] 芯片启动初始化**: 复刻了基础的初始化序列。
*   **[已实现] 触摸帧读取**: 能够稳定读取 Master/Slave 的原始数据流。
*   **[已实现] 芯片关机逻辑**: `hx_sense_off` 代码已实现（参考了 Linux 方案），但**尚未在实机验证**其正确性。
*   **[未实现] 手写笔 (240Hz) 模式**: 尚未找到激活方法。
*   **[未实现] 核心工作线程**: 芯片工作主循环与触摸帧解析线程尚未完成。
*   **[未实现] 系统状态监测**: 用于捕获屏幕亮灭（S0/S3 状态切换）的 `SystemDetector` 线程尚未实现。
