## Plan: EGoTouchRev 架构重构方案

本文档汇总了 HimaxChip 上帝类拆分、TouchEngine 主循环设计、以及 FrameProcessor 模块规划的完整架构方案。

---

### 一、问题分析

#### 1.1 HimaxChip 上帝类问题

当前 HimaxChip.cpp 承担 6 种职责：

| 职责    | 相关代码                                                   |
| ----- | ------------------------------------------------------ |
| 设备通信  | `m_master`, `m_slave`, `m_interrupt`, `CheckBus()`     |
| 硬件控制  | `hardware_rst_AHB()`, `software_rst_AHB()`             |
| 寄存器操作 | `m_ic_op`, `m_fw_op`, `m_flash_op` 等 6 个操作类            |
| 数据处理  | `thp_afe_frame_solve()`, `TouchEngine()`               |
| 状态管理  | `isRuning`, `afe_mode`, `inspection_mode`              |
| 初始化配置 | `init_buffer()`, `set_N_frame()`, `set_rawdata_type()` |

#### 1.2 性能特征

| 参数       | 值                                  |
| -------- | ---------------------------------- |
| 触摸屏分辨率   | 60 × 40 像素                         |
| 每帧数据量    | 60 × 40 × 2 = 4,800 字节             |
| 实际传输量    | Master 5063 + Slave 339 = 5,402 字节 |
| 帧率       | 240 Hz（带手写笔）                       |
| 每帧时间预算   | 4.17 ms                            |
| 帧处理计算耗时  | < 0.1 ms                           |
| I/O 读取耗时 | 1.5 - 3 ms                         |

**结论**：瓶颈在 I/O，非 CPU 计算；**单线程足以满足需求**，多线程会引入不必要的同步开销。

---

### 二、架构方案

#### 2.1 模块划分

```
Common/                          ← 通用基础设施
├── Logger.h / .cpp              （已有）
└── TouchTypes.h                 ← 新增：厂商无关的数据结构

HimaxChipCore/                   ← Himax 芯片核心（厂商绑定）
├── header/
│   ├── HimaxChip.h              （精简后）
│   ├── HimaxProtocol.h          （已有）
│   ├── HimaxRegisters.h         （已有）
│   ├── DeviceManager.h          ← 新增：设备连接管理
│   ├── AfeController.h          ← 新增：AFE 控制逻辑
│   └── HimaxFrameProcessor.h    ← 新增：帧解析处理
└── source/
    └── ...对应实现文件

EGoTouchService/                 ← 应用服务层
├── header/
│   └── TouchEngine.h            ← 新增：主循环控制器
└── source/
    ├── main.cpp                 （已有）
    └── TouchEngine.cpp          ← 新增
```

#### 2.2 类职责划分

| 新类                    | 职责                               | 从 Chip 提取的内容                                                      |
| --------------------- | -------------------------------- | ----------------------------------------------------------------- |
| `DeviceManager`       | 管理 Master/Slave/Interrupt 设备生命周期 | `m_master`, `m_slave`, `m_interrupt`, `CheckBus()`, `SelectDev()` |
| `AfeController`       | AFE 模式控制、感应开关                    | `thp_afe_start()`, `hx_sense_on/off()`, `afe_mode`                |
| `HimaxFrameProcessor` | 解析原始帧为触控点                        | `thp_afe_frame_solve()`                                           |
| `TouchEngine`         | 主循环协调                            | `TouchEngine()`, `isRuning`                                       |
| `Chip` (精简)           | 门面类，组合上述组件                       | 保留初始化入口                                                           |

#### 2.3 数据流设计

```
┌─────────────────────────────────────────────────────────────────┐
│                      TouchEngine 主循环                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐     │
│   │ WaitInterrupt│───>│  GetFrame    │───>│FrameProcessor│     │
│   │   (阻塞)     │    │ (Master+Slave)│    │   (解析)     │     │
│   └──────────────┘    └──────────────┘    └──────┬───────┘     │
│                                                  │              │
│                                                  ▼              │
│                                          TouchFrame 输出        │
│                                          (触控点坐标)           │
└─────────────────────────────────────────────────────────────────┘
```

---

### 三、实施步骤

#### 步骤 1：创建通用数据结构

在 `Common/TouchTypes.h` 定义：

- `struct TouchPoint { uint16_t x, y, pressure; }`
- `struct TouchFrame { std::vector<TouchPoint> points; uint64_t timestamp; }`

#### 步骤 2：创建 HimaxFrameProcessor

在 `HimaxChipCore/header/HimaxFrameProcessor.h`：

- 输入：`std::span<uint8_t, 8192> rawFrame`
- 输出：`TouchFrame`
- 处理管道：`RawDecoder` → `NoiseFilter` → `TouchExtractor`
- 60×40 矩阵常量定义

#### 步骤 3：提取 DeviceManager

从 `HimaxChip` 提取设备管理逻辑：

- 封装 `m_master`, `m_slave`, `m_interrupt`
- 提供 `GetFrame()`, `WaitInterrupt()` 统一接口
- 可选：实现 Master/Slave 并行读取（Overlapped I/O）

#### 步骤 4：提取 AfeController

从 `HimaxChip` 提取 AFE 控制逻辑：

- `Start()`, `Stop()`, `SetMode()`
- 管理 `afe_mode` 状态机

#### 步骤 5：创建 TouchEngine

在 `EGoTouchService/header/TouchEngine.h`：

- 组合 `DeviceManager`, `AfeController`, `HimaxFrameProcessor`
- 单线程同步主循环
- 提供 `Start()`, `Stop()`, `SetMode()` 接口

#### 步骤 6：精简 Chip 类

保留为门面(Facade)类：

- 组合上述组件
- 提供简化的初始化入口
- 委托具体操作给子组件

---

### 四、设计决策说明

| 决策                | 选择            | 理由                             |
| ----------------- | ------------- | ------------------------------ |
| 线程模型              | 单线程同步         | 计算 <0.1ms，多线程上下文切换开销（~50μs）不划算 |
| FrameProcessor 归属 | HimaxChipCore | 帧格式完全绑定 Himax 硬件，暂无多厂商需求       |
| 抽象接口              | 暂不创建          | YAGNI 原则，需要时再抽象                |
| I/O 优化            | 可选并行读取        | Master/Slave 并行可节省 ~1ms，非必须    |

---

### 五、后续扩展点

1. **VHF 注入**：TouchEngine 输出 `TouchFrame` 后，传递给 VHF 模块上报系统
2. 
3. **SIMD 加速**：若帧处理增加复杂算法，可在 `HimaxFrameProcessor` 中使用 NEON 指令
4. **多厂商支持**：在 Common 中抽象 `IFrameProcessor` 接口，各厂商实现子类
